name: æ¯æ—¥æ–°å“åŒæ­¥

on:
  # æ¯å¤©æ—¥æœ¬æ™‚é–“ 12:00 è‡ªå‹•åŸ·è¡Œ (UTC 03:00)
  schedule:
    - cron: '0 3 * * *'

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      brands:
        description: 'æŒ‡å®šè¦è™•ç†çš„å“ç‰Œ (ç”¨ç©ºæ ¼åˆ†éš”ï¼Œä¸æŒ‡å®šå‰‡è™•ç†å…¨éƒ¨)'
        required: false
        default: ''
      environment:
        description: 'åŸ·è¡Œç’°å¢ƒ'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

  # å…è¨±å¾žå…¶ä»– workflow å‘¼å«
  workflow_call:
    inputs:
      brands:
        description: 'æŒ‡å®šè¦è™•ç†çš„å“ç‰Œ'
        type: string
        default: ''
      environment:
        description: 'åŸ·è¡Œç’°å¢ƒ'
        type: string
        default: 'production'

env:
  NODE_VERSION: '20'
  TZ: 'Asia/Tokyo'

jobs:
  scrape-products:
    name: çˆ¬å–ç”¢å“è³‡è¨Š
    runs-on: ubuntu-latest

    steps:
      - name: æª¢æŸ¥æŽ’ç¨‹ç‹€æ…‹
        if: github.event_name == 'schedule'
        run: |
          echo "åŸ·è¡Œæ¯æ—¥æŽ’ç¨‹ä»»å‹™ - $(date '+%Y-%m-%d %H:%M:%S %Z')"

      - name: æª¢æŸ¥æ‰‹å‹•è§¸ç™¼
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "æ‰‹å‹•è§¸ç™¼ä»»å‹™"
          if [ -n "${{ github.event.inputs.brands }}" ]; then
            echo "æŒ‡å®šå“ç‰Œ: ${{ github.event.inputs.brands }}"
          fi

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£ Playwright ç€è¦½å™¨
        run: |
          npx playwright install --with-deps chromium

      - name: æª¢æŸ¥ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: å¿«å– node_modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: å®‰è£ä¾è³´
        run: npm ci

      - name: å»ºç½®å°ˆæ¡ˆ
        run: npm run build

      - name: å»ºç«‹ç’°å¢ƒè®Šæ•¸æª”æ¡ˆ
        run: |
          cat > .env << EOF
          # ç’°å¢ƒè®Šæ•¸é…ç½®
          NODE_ENV=${{ github.event.inputs.environment || 'production' }}

          # OpenAI API é…ç½®
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}

          # Supabase é…ç½®
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          EOF

      - name: åŸ·è¡Œçˆ¬èŸ²
        id: scrape
        run: |
          # è¨­å®šæ™‚å€ç‚ºæ—¥æœ¬æ™‚é–“
          export TZ='Asia/Tokyo'

          # æº–å‚™åŸ·è¡Œåƒæ•¸
          BRANDS="${{ github.event.inputs.brands }}"
          if [ -z "$BRANDS" ]; then
            echo "è™•ç†æ‰€æœ‰å•Ÿç”¨å“ç‰Œ"
            npm run scraper:run
          else
            echo "è™•ç†æŒ‡å®šå“ç‰Œ: $BRANDS"
            npm run scraper:run $BRANDS
          fi
        continue-on-error: true

      - name: ä¸Šå‚³åŸ·è¡Œæ—¥èªŒ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraper-logs-${{ github.run_id }}
          path: |
            *.log
            logs/
          retention-days: 7

      - name: é€šçŸ¥çµæžœ
        if: always()
        run: |
          if [ ${{ steps.scrape.outcome }} == 'success' ]; then
            echo "âœ… çˆ¬èŸ²ä»»å‹™æˆåŠŸå®Œæˆ"
          else
            echo "âŒ çˆ¬èŸ²ä»»å‹™å¤±æ•—"
            exit 1
          fi

      - name: ç™¼é€ Discord é€šçŸ¥
        if: always()
        run: |
          # å¦‚æžœæœ‰è¨­å®š Discord webhookï¼Œå¯ä»¥åœ¨é€™è£¡ç™¼é€é€šçŸ¥
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            STATUS="${{ steps.scrape.outcome }}"
            BRANDS="${{ github.event.inputs.brands || 'å…¨éƒ¨å“ç‰Œ' }}"
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S %Z')

            if [ "$STATUS" == "success" ]; then
              MESSAGE="âœ… æ—¥æœ¬æ–°å“çˆ¬èŸ²ä»»å‹™æˆåŠŸå®Œæˆ\\nðŸ“… $TIMESTAMP\\nðŸª $BRANDS"
              COLOR="3066993"
            else
              MESSAGE="âŒ æ—¥æœ¬æ–°å“çˆ¬èŸ²ä»»å‹™å¤±æ•—\\nðŸ“… $TIMESTAMP\\nðŸª $BRANDS"
              COLOR="15158332"
            fi

            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"embeds\": [{\"title\": \"æ—¥æœ¬æ–°å“è¿½è¹¤ç³»çµ±\", \"description\": \"$MESSAGE\", \"color\": $COLOR}]}" \
                 ${{ secrets.DISCORD_WEBHOOK_URL }}
          fi

  # å¯é¸ï¼šè³‡æ–™è™•ç†ä»»å‹™ (å¦‚æžœéœ€è¦å°‡çµæžœå­˜å…¥è³‡æ–™åº«)
  process-data:
    name: è™•ç†è³‡æ–™
    runs-on: ubuntu-latest
    needs: scrape-products
    if: needs.scrape-products.result == 'success'

    steps:
      - name: æª¢æŸ¥ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£ä¾è³´
        run: npm ci

      - name: è™•ç†çˆ¬å–çµæžœ
        run: |
          # æ­¤è™•å¯ä»¥æ·»åŠ è³‡æ–™è™•ç†é‚è¼¯
          # ä¾‹å¦‚ï¼šå°‡çµæžœå­˜å…¥ Supabaseã€ç™¼é€é€šçŸ¥ç­‰
          echo "è³‡æ–™è™•ç†ä»»å‹™ - å¾…å¯¦ä½œ"
          echo "å¯ä»¥å°‡çˆ¬å–çµæžœå­˜å…¥ Supabase æˆ–å…¶ä»–è³‡æ–™åº«"

      - name: æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
        run: |
          # æ¸…ç†ä¸éœ€è¦çš„æª”æ¡ˆ
          echo "æ¸…ç†å®Œæˆ"